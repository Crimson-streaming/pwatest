workflows:
  ios-cloudy-build:
    name: Cloudy iOS App
    max_build_duration: 60
    instance_type: mac_mini_m1
    
    environment:
      xcode: latest
      cocoapods: default
      
      vars:
        XCODE_WORKSPACE: "Cloudy.xcworkspace"
        XCODE_SCHEME: "Cloudy"
    
    scripts:
      - name: Show project info
        script: |
          echo "üì± === PROJET CLOUDY ==="
          echo "Workspace: $XCODE_WORKSPACE"
          echo "Scheme: $XCODE_SCHEME"
          echo ""
          echo "üìÇ === STRUCTURE DU PROJET ==="
          ls -la
      
      - name: Install CocoaPods dependencies
        script: |
          if [ -f "Podfile" ]; then
            echo "üì¶ Installation des CocoaPods..."
            pod install
          else
            echo "‚ÑπÔ∏è Pas de Podfile trouv√©, skip"
          fi
      
      - name: List available schemes
        script: |
          echo "üîç === SCHEMES DISPONIBLES ==="
          xcodebuild -list -workspace "$XCODE_WORKSPACE"
      
      - name: Build archive
        script: |
          echo "üî® === COMPILATION DE CLOUDY ==="
          
          xcodebuild -workspace "$XCODE_WORKSPACE" \
                     -scheme "$XCODE_SCHEME" \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath "$CM_BUILD_DIR/build/Cloudy.xcarchive" \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGNING_ALLOWED=NO \
                     archive
      
      - name: Create IPA
        script: |
          echo "üì¶ === CR√âATION DU .IPA ==="
          
          # Trouver l'app compil√©e
          APP_PATH=$(find "$CM_BUILD_DIR/build/Cloudy.xcarchive/Products/Applications" -name "*.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå App non trouv√©e"
            echo "Contenu de l'archive:"
            ls -R "$CM_BUILD_DIR/build/Cloudy.xcarchive"
            exit 1
          fi
          
          echo "‚úÖ App trouv√©e: $APP_PATH"
          
          # Cr√©er le .ipa
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r Cloudy.ipa Payload
          
          # D√©placer dans output
          mkdir -p "$CM_BUILD_DIR/output"
          mv Cloudy.ipa "$CM_BUILD_DIR/output/"
          
          echo ""
          echo "‚úÖ === IPA CR√â√â ==="
          ls -lh "$CM_BUILD_DIR/output/Cloudy.ipa"
    
    artifacts:
      - output/*.ipa
      - build/Cloudy.xcarchive
    
    publishing:
      email:
        recipients:
          - ton-email@gmail.com  # ‚¨ÖÔ∏è CHANGE TON EMAIL ICI
        notify:
          success: true
          failure: true